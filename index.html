
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ShopLens — Visual Shopping (Static)</title>
<style>
:root{ --bg:#fffafc; --ink:#263238; --edge:#ffdbe7; --accent:#ff6db3; --sky:#6ee7ff; --sun:#ffd36e; --radius:22px; }
*{box-sizing:border-box}
body{ margin:0; font:16px/1.5 ui-sans-serif, system-ui, -apple-system, "Segoe UI"; background:
  radial-gradient(60% 40% at 10% -10%, rgba(255,109,179,.25), transparent 60%),
  radial-gradient(60% 40% at 110% 10%, rgba(110,231,255,.25), transparent 60%),
  radial-gradient(40% 30% at 50% 120%, rgba(255,211,110,.25), transparent 60%), var(--bg); color:var(--ink);}
.wrap{ max-width:1000px; margin:30px auto 80px; padding:0 20px; }
.header{ display:flex; justify-content:space-between; align-items:center; gap:16px; }
.logo{ font-weight:900; font-size:26px }
.card{ background:#fff; border:3px solid var(--edge); border-radius:var(--radius); padding:16px; box-shadow:0 8px 0 #ffc2db; }
.grid{ display:grid; grid-template-columns:3fr 5fr; gap:16px; margin-top:14px }
button{ background:linear-gradient(90deg, var(--accent), #ffa1cc); border:none; color:#fff; font-weight:800; padding:10px 14px; border-radius:12px; cursor:pointer }
input[type=file]{ display:block; padding:10px; border:2px dashed var(--edge); border-radius:14px; background:#fff; width:100% }
.results{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
.prod{ background:#fff; border:2px solid var(--edge); border-radius:16px; overflow:hidden }
.prod img{ width:100%; display:block }
.prod .info{ padding:10px }
.badge{ display:inline-block; padding:4px 8px; border-radius:999px; background:#fff0f7; border:1.5px solid var(--edge); font-size:12px }
small.muted{ color:#68707c }
@media (max-width:900px){ .grid{grid-template-columns:1fr} .results{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<nav style="max-width:1000px;margin:12px auto;padding:0 20px;display:flex;justify-content:flex-end;gap:12px;font-family:ui-sans-serif,system-ui;">
  <a href="dashboard.html" style="text-decoration:none;padding:8px 12px;border:2px solid #ffdbe7;border-radius:12px;background:#fff">Project Dashboard</a>
</nav>

<div class="wrap">
  <div class="header">
    <div class="logo">ShopLens</div>
    <div class="badge">Static — No server</div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Upload an outfit</h3>
      <input id="file" type="file" accept="image/*">
      <div style="display:flex; gap:10px; margin-top:10px">
        <button id="matchBtn">Get Matches</button>
        <button id="demoBtn" style="background:linear-gradient(90deg, var(--sky), #c7f3ff); color:#124d58;">Use Demo Image</button>
      </div>
      <p id="status"></p>
      <img id="preview" style="margin-top:10px; max-width:100%; border-radius:12px; display:none" />
      <p><small class="muted">All matching runs client‑side in your browser (HSV color histogram over a tiny catalog).</small></p>
    </div>
    <div class="card">
      <h3>Matches</h3>
      <div class="results" id="results"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>How it works</h3>
    <ol>
      <li>Your image never leaves the browser.</li>
      <li>We compute a tiny HSV histogram via Canvas.</li>
      <li>We compare it to precomputed histograms from <code>products.json</code> and show the top‑3.</li>
    </ol>
  </div>
</div>

<script>
let CATALOG = [];
const fileEl = document.getElementById('file');
const preview = document.getElementById('preview');
const statusEl = document.getElementById('status');
const results = document.getElementById('results');

async function loadCatalog(){
  const res = await fetch('products.json');
  CATALOG = await res.json();
}
loadCatalog();

// demo image (a pink square) so you can click without uploading
let demoBlob = null;
(async ()=>{
  const c = document.createElement('canvas'); c.width = c.height = 256;
  const ctx = c.getContext('2d'); ctx.fillStyle = '#ff7dab'; ctx.fillRect(0,0,256,256);
  demoBlob = await new Promise(r=>c.toBlob(r, 'image/png'));
})();

fileEl.addEventListener('change', () => {
  const file = fileEl.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => { preview.src = reader.result; preview.style.display='block'; };
  reader.readAsDataURL(file);
});

document.getElementById('demoBtn').onclick = async () => {
  preview.src = URL.createObjectURL(demoBlob); preview.style.display='block';
  const feats = await featuresFromBlob(demoBlob);
  showMatches(rank(feats, 3));
};

document.getElementById('matchBtn').onclick = async () => {
  const file = fileEl.files[0] || demoBlob;
  if (!file) { alert('Choose an image or use the demo image'); return; }
  const feats = await featuresFromBlob(file);
  showMatches(rank(feats, 3));
};

function showMatches(items){
  results.innerHTML = '';
  items.forEach(({prod, score}) => {
    const el = document.createElement('div'); el.className='prod';
    el.innerHTML = \`
      <img src="\${prod.image}" alt="\${prod.name}">
      <div class="info">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong>\${prod.name}</strong>
          <span>$\${prod.price.toFixed(2)}</span>
        </div>
        <div class="badge">sim \${score.toFixed(2)}</div>
      </div>\`;
    results.appendChild(el);
  });
  statusEl.textContent = 'Done.';
}

// --- Matching utilities (browser) ---
async function featuresFromBlob(blob){
  statusEl.textContent = 'Analyzing image...';
  const bmp = await createImageBitmap(blob);
  const c = document.createElement('canvas'); c.width = 128; c.height = 128;
  const ctx = c.getContext('2d');
  ctx.drawImage(bmp, 0, 0, 128, 128);
  const {data} = ctx.getImageData(0,0,128,128);
  const bins = 16;
  const hHist = new Float32Array(bins);
  const sHist = new Float32Array(bins);
  const vHist = new Float32Array(bins);
  for(let i=0;i<data.length;i+=4){
    const r = data[i]/255, g = data[i+1]/255, b = data[i+2]/255;
    const cmax = Math.max(r,g,b), cmin = Math.min(r,g,b), delta = cmax - cmin || 1e-6;
    let h;
    if (cmax === r){ h = ((g-b)/delta) % 6; }
    else if (cmax === g){ h = (b-r)/delta + 2; }
    else { h = (r-g)/delta + 4; }
    h = (h*60); if (h<0) h+=360; h/=360;
    const s = cmax === 0 ? 0 : delta / cmax;
    const v = cmax;
    const hi = Math.min(bins-1, Math.floor(h*bins));
    const si = Math.min(bins-1, Math.floor(s*bins));
    const vi = Math.min(bins-1, Math.floor(v*bins));
    hHist[hi]+=1; sHist[si]+=1; vHist[vi]+=1;
  }
  function l2norm(arr){
    let sum=0; for(let i=0;i<arr.length;i++) sum+=arr[i]*arr[i];
    const n = Math.sqrt(sum)||1e-8;
    for(let i=0;i<arr.length;i++) arr[i]/=n;
    return arr;
  }
  l2norm(hHist); l2norm(sHist); l2norm(vHist);
  const feat = new Float32Array(bins*3);
  feat.set(hHist,0); feat.set(sHist,bins); feat.set(vHist,bins*2);
  return feat;
}

function cosine(a, b){
  let dot=0, na=0, nb=0;
  for(let i=0;i<a.length;i++){ dot+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; }
  return dot / (Math.sqrt(na)*Math.sqrt(nb) + 1e-8);
}

function rank(queryFeat, k){
  const scores = CATALOG.map(p => {
    const f = new Float32Array(p.features);
    return { prod: p, score: cosine(queryFeat, f) };
  });
  scores.sort((x,y)=>y.score - x.score);
  return scores.slice(0, k);
}
</script>
</body>
</html>
